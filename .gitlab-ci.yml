# ------------------------------------------------------------------------------
# ARCHIVO: .gitlab-ci.yml
#
# PROP√ìSITO
# ----------
# Este archivo define un pipeline completo de CI/CD enfocado principalmente
# en VALIDACI√ìN, SEGURIDAD y AN√ÅLISIS de una aplicaci√≥n contenerizada.
#
# El pipeline est√° dise√±ado para:
# - Validar la calidad del Dockerfile
# - Analizar dependencias Node.js
# - Construir y publicar la imagen Docker
# - Escanear vulnerabilidades con Trivy
# - Integrar reportes de seguridad en GitLab
# - Ejecutar an√°lisis de calidad de c√≥digo (SonarQube)
# - Generar un resumen final de seguridad
#
# El enfoque es DevSecOps: la seguridad se integra desde las primeras etapas
# del ciclo de vida del software.
# ------------------------------------------------------------------------------


# ------------------------------------------------------------------------------
# DEFINICI√ìN DE ETAPAS DEL PIPELINE
#
# El pipeline se ejecuta de forma secuencial siguiendo este orden l√≥gico:
# 1. validate  ‚Üí validaciones tempranas (Dockerfile, dependencias)
# 2. build     ‚Üí construcci√≥n de la imagen Docker
# 3. security  ‚Üí escaneos de seguridad (Trivy, SonarQube)
# 4. report    ‚Üí consolidaci√≥n y visualizaci√≥n de resultados
# ------------------------------------------------------------------------------


# GitLab CI/CD Pipeline de Seguridad

stages:
  - validate
  - build
  - security
  - report


# ------------------------------------------------------------------------------
# VARIABLES GLOBALES DEL PIPELINE
#
# Estas variables se reutilizan en m√∫ltiples jobs para:
# - Nombrar im√°genes Docker
# - Definir el tag basado en el commit
# - Configurar Docker-in-Docker
# ------------------------------------------------------------------------------
variables:
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# ============================================
# STAGE 1: VALIDACI√ìN DE DOCKERFILE
# ============================================
# Este job ejecuta Hadolint para analizar el Dockerfile
# y detectar malas pr√°cticas, errores de seguridad o
# problemas de mantenibilidad.
#
# Es una validaci√≥n temprana que falla el pipeline si
# se detectan problemas importantes.
hadolint:
  stage: validate
  image: hadolint/hadolint:latest-alpine
  script:
    - hadolint Dockerfile --config .hadolint.yaml
  allow_failure: false
  only:
    - branches
    - merge_requests

# ============================================
# STAGE 2: AN√ÅLISIS DE DEPENDENCIAS (npm audit)
# ============================================
# Este job analiza las dependencias Node.js en busca
# de vulnerabilidades conocidas utilizando npm audit.
#
# Se genera un reporte JSON que luego se usa en el
# resumen de seguridad.
#
# allow_failure: true permite continuar el pipeline
# aunque se detecten vulnerabilidades (enfoque informativo).
npm-audit:
  stage: validate
  image: node:18-alpine
  before_script:
    - npm ci
  script:
    - npm audit --json > npm-audit-report.json || true
    - npm audit --audit-level=moderate
  artifacts:
    paths:
      - npm-audit-report.json
    expire_in: 1 week
  allow_failure: true
  only:
    - branches
    - merge_requests

# ============================================
# STAGE 3: BUILD DE IMAGEN DOCKER
# ============================================
# Este job construye la imagen Docker de la aplicaci√≥n
# y la publica en el Container Registry de GitLab.
#
# Usa Docker-in-Docker (dind) para poder ejecutar
# comandos docker dentro del job.
build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
    - docker push ${IMAGE_NAME}:${IMAGE_TAG}
  only:
    - branches
    - merge_requests

# ============================================
# STAGE 4: ESCANEO DE SEGURIDAD CON TRIVY
# ============================================
# Este job analiza la imagen Docker construida
# en busca de vulnerabilidades conocidas en:
# - Sistema operativo base
# - Librer√≠as
# - Dependencias
#
# El pipeline falla si se detectan vulnerabilidades
# de severidad CRITICAL.
trivy-scan:
  stage: security
  image: aquasec/trivy:latest
  dependencies:
    - build
  before_script:
    - export TRIVY_VERSION=$(wget -qO - "https://api.github.com/repos/aquasecurity/trivy/releases/latest" | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
  script:
    # Escaneo completo
    - trivy image --format json --output trivy-report.json ${IMAGE_NAME}:${IMAGE_TAG}
    - trivy image --format table --output trivy-report.txt ${IMAGE_NAME}:${IMAGE_TAG}
    
    # Verificar CRITICAL (fail si encuentra)
    - trivy image --exit-code 1 --severity CRITICAL ${IMAGE_NAME}:${IMAGE_TAG}
    
    # Reporte para GitLab Security Dashboard
    - trivy image --format template --template "@/contrib/gitlab.tpl" --output gl-container-scanning-report.json ${IMAGE_NAME}:${IMAGE_TAG}
  artifacts:
    paths:
      - trivy-report.json
      - trivy-report.txt
    reports:
      container_scanning: gl-container-scanning-report.json
    expire_in: 1 week
  allow_failure: false
  only:
    - branches
    - merge_requests

# ============================================
# STAGE 5: AN√ÅLISIS DE CALIDAD DE C√ìDIGO (SONARQUBE)
# ============================================
# Job opcional que ejecuta an√°lisis est√°tico de c√≥digo
# usando SonarQube / SonarCloud.
#
# allow_failure: true porque no bloquea el pipeline
# ante problemas de calidad.
sonarqube-check:
  stage: security
  image: 
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script: 
    - sonar-scanner
  allow_failure: true
  only:
    - branches
    - merge_requests
  except:
    - schedules

# ============================================
# STAGE 6: REPORTE CONSOLIDADO DE SEGURIDAD
# ============================================
# Este job genera un resumen legible en consola
# combinando resultados de npm audit y Trivy.
#
# Su objetivo es facilitar la lectura r√°pida del
# estado de seguridad del proyecto.
security-report:
  stage: report
  image: alpine:latest
  dependencies:
    - npm-audit
    - trivy-scan
  before_script:
    - apk add --no-cache jq
  script:
    - |
      echo "======================================" 
      echo "SECURITY SCAN SUMMARY"
      echo "======================================"
      echo ""
      
      echo "üì¶ npm audit results:"
      if [ -f npm-audit-report.json ]; then
        jq -r '.metadata.vulnerabilities | to_entries[] | "\(.key): \(.value)"' npm-audit-report.json || echo "No vulnerabilities data"
      fi
      
      echo ""
      echo "üîç Trivy results:"
      if [ -f trivy-report.json ]; then
        jq -r '.Results[].Vulnerabilities | length' trivy-report.json | awk '{s+=$1} END {print "Total vulnerabilities: " s}' || echo "No vulnerabilities"
      fi
      
      echo ""
      echo "üìã Detailed reports available in artifacts"
  artifacts:
    paths:
      - npm-audit-report.json
      - trivy-report.json
      - trivy-report.txt
    expire_in: 1 month
  only:
    - branches
    - merge_requests

# ============================================
# JOB PROGRAMADO: ESCANEO NOCTURNO
# ============================================
# Job que se ejecuta mediante schedules para
# escanear la imagen latest de forma peri√≥dica,
# incluso sin nuevos commits.
nightly-security:
  stage: security
  image: aquasec/trivy:latest
  script:
    - trivy image --format json --output trivy-nightly-report.json ${IMAGE_NAME}:latest
    - trivy image --format table ${IMAGE_NAME}:latest
  artifacts:
    paths:
      - trivy-nightly-report.json
    expire_in: 1 week
  only:
    - schedules
